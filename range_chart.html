
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ポーカー戦略チャート (完全版)</title>
  <style>
    :root {
      --bg-color: #f9f9f9;
      --text-color: #333;
      --table-bg: white;
    }
    body.dark {
      --bg-color: #121212;
      --text-color: #f0f0f0;
      --table-bg: #1e1e1e;
    }
    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      font-family: sans-serif;
      margin: 0;
      padding: 10px;
    }
    h1 {
      text-align: center;
      font-size: 1.4rem;
    }
    select, button {
      margin: 6px 0;
      padding: 10px;
      font-size: 1rem;
      width: 95%;
      max-width: 280px;
    }
    .controls {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 10px;
    }
    .result-box {
      background: var(--table-bg);
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
      overflow-x: auto;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      min-width: 500px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 4px;
      text-align: center;
      font-size: 12px;
      cursor: pointer;
    }
    th {
      background-color: #f0f0f0;
    }
    .popup {
      display: none;
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 10px 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      z-index: 100;
    }
  </style>
</head>
<body>
<h1>♠️ ポーカー戦略チャート (完全版)</h1>

<div class="controls">
  <select id="actionSelect" onchange="updateOptions()"></select>
  <select id="selfSelect" onchange="updateOptions()"></select>
  <select id="vsSelect" onchange="updateOptions()"></select>
  <select id="stackSelect" onchange="updateOptions()"></select>
  <select id="typeSelect"></select>
  <button onclick="showSelected()">📊 レンジ表示</button>
  <button onclick="toggleDarkMode()">🌓 テーマ切替</button>
  <button onclick="captureTable()">🖼️ レンジ画像保存</button>
</div>

<div class="result-box" id="resultBox">
  <p>ここにレンジ表が表示されます</p>
</div>
<div class="popup" id="popupBox"></div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
let rangeData = {};
let evData = {};
const validTree = {
  "open": {
    "UTG": { "": { "15": ["tight","normal","loose"], "30": ["tight","normal","loose"], "50": ["tight","normal","loose"], "100": ["tight","normal","loose"] } },
    "HJ": { "": { "15": ["tight","normal","loose"], "30": ["tight","normal","loose"], "50": ["tight","normal","loose"], "100": ["tight","normal","loose"] } },
    "CO": { "": { "15": ["tight","normal","loose"], "30": ["tight","normal","loose"], "50": ["tight","normal","loose"], "100": ["tight","normal","loose"] } },
    "BTN":{ "": { "15": ["tight","normal","loose"], "30": ["tight","normal","loose"], "50": ["tight","normal","loose"], "100": ["tight","normal","loose"] } },
    "SB":  { "": { "15": ["tight","normal","loose"], "30": ["tight","normal","loose"], "50": ["tight","normal","loose"], "100": ["tight","normal","loose"] } },
    "BB":  { "": { "15": ["tight","normal","loose"], "30": ["tight","normal","loose"], "50": ["tight","normal","loose"], "100": ["tight","normal","loose"] } }
  }
};

fetch("range_data.json").then(r => r.json()).then(json => { rangeData = json; initSelectors(); });
fetch("ev_data.json").then(r => r.json()).then(json => { evData = json; });

function populateSelect(select, options) {
  select.innerHTML = '';
  for (const val of options) {
    const opt = document.createElement('option');
    opt.value = val;
    opt.textContent = val;
    select.appendChild(opt);
  }
}

function updateOptions() {
  const action = document.getElementById("actionSelect").value;
  const self = document.getElementById("selfSelect").value;
  const vsBox = document.getElementById("vsSelect");
  const stackBox = document.getElementById("stackSelect");
  const typeBox = document.getElementById("typeSelect");

  const vsOptions = Object.keys(validTree[action][self]);
  vsBox.style.display = (action === "open") ? "none" : "inline-block";
  populateSelect(vsBox, vsOptions);
  const vs = vsBox.value;

  const stackOptions = Object.keys(validTree[action][self][vs]);
  populateSelect(stackBox, stackOptions);
  const stack = stackBox.value;

  const typeOptions = validTree[action][self][vs][stack];
  populateSelect(typeBox, typeOptions);
}

function showSelected() {
  const action = document.getElementById("actionSelect").value;
  const self = document.getElementById("selfSelect").value;
  const vs = document.getElementById("vsSelect").value;
  const stack = document.getElementById("stackSelect").value;
  const type = document.getElementById("typeSelect").value;
  const result = document.getElementById("resultBox");

  let table = (action === "open") ? rangeData?.[action]?.[self]?.[stack]?.[type]
                                  : rangeData?.[action]?.[self]?.[vs]?.[stack]?.[type];

  if (!table) {
    result.innerHTML = `<p>※この条件のレンジ表は未登録です。</p>`;
    return;
  }

  const labels = ['A','K','Q','J','T','9','8','7','6','5','4','3','2'];
  let html = `<h3>${self} / ${stack}BB / ${action}${action !== "open" ? " vs " + vs : ""} / ${type}</h3>`;
  html += `<table><tr><th></th>${labels.map(l => `<th>${l}</th>`).join('')}</tr>`;
  for (let i = 0; i < labels.length; i++) {
    html += `<tr><th>${labels[i]}</th>` + table[i].map(cell => {
      const val = cell || "";
      return `<td onclick="showPopup('${val}')">${val}</td>`;
    }).join('') + "</tr>";
  }
  html += "</table>";
  result.innerHTML = html;
}

function showPopup(hand) {
  if (!hand) return;
  const data = evData[hand];
  const popup = document.getElementById('popupBox');
  popup.innerHTML = data
    ? `<strong>${hand}</strong><br>EV: ${data.ev} / 勝率: ${data.winRate}%<br>${data.note}`
    : `<strong>${hand}</strong><br>データなし`;
  popup.style.display = 'block';
  setTimeout(() => { popup.style.display = 'none'; }, 3500);
}

function toggleDarkMode() {
  document.body.classList.toggle("dark");
}

function captureTable() {
  html2canvas(document.getElementById('resultBox')).then(canvas => {
    const link = document.createElement('a');
    link.download = 'range_chart.png';
    link.href = canvas.toDataURL();
    link.click();
  });
}

function initSelectors() {
  populateSelect(document.getElementById("actionSelect"), Object.keys(validTree));
  populateSelect(document.getElementById("selfSelect"), Object.keys(validTree["open"]));
  updateOptions();
}
</script>
</body>
</html>
